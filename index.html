<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walk-In Verifier</title>
    <style>
        :root {
            /* Chipotle-inspired Palette */
            --chili-dark: #451400;   /* Dark Maroon/Brown */
            --chili-red: #AD2E24;    /* Bright Accent Red */
            --kraft-bg: #F4F1EA;     /* Paper Bag Beige */
            --foil-silver: #E0E0E0;  /* Silver/Grey */
            --text-dark: #333333;
            --white: #FFFFFF;
            
            --primary: var(--chili-dark);
            --bg: var(--kraft-bg);
            --card-bg: var(--white);
            --border: #D4C4A9;       /* Darker beige border */
            
            --success: #2e7d32;
            --warning: #ed6c02;
            --danger: #d32f2f;
        }

        body {
            font-family: "Trade Gothic LT Std", "Franklin Gothic Medium", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- Header & Nav --- */
        .top-bar {
            background-color: var(--chili-dark);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .app-title:hover {
            opacity: 0.8;
        }

        /* --- Main Content --- */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Cards --- */
        .card {
            background: var(--card-bg);
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #dcdcdc;
            padding: 30px;
            margin-bottom: 25px;
        }

        /* Headers */
        .section-header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--chili-dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        h3 {
            text-transform: uppercase;
            font-weight: 800;
            color: var(--chili-dark);
            margin: 0;
            display: inline-block;
        }

        /* --- Settings Cog & Buttons --- */
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--chili-dark);
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s, transform 0.5s ease;
        }

        .icon-btn:hover {
            background-color: #f0f0f0;
            transform: rotate(90deg);
            color: var(--chili-red);
        }

        .btn-text-back {
            background: none;
            border: none;
            color: #666;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 10px 0;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }
        .btn-text-back:hover {
            color: var(--chili-red);
        }
        .btn-text-back svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .bottom-return-container {
            text-align: center;
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        /* --- Control Panel Grid --- */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Equal width columns */
            gap: 25px;
            align-items: start;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .control-panel { grid-template-columns: 1fr; }
        }

        .panel-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            color: var(--chili-dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        /* --- Tooltip Help System --- */
        .help-tip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            cursor: help;
        }

        .help-icon {
            background-color: #999; /* Opaque grey */
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 11px;
            line-height: 16px;
            text-align: center;
            font-weight: 800;
            display: block;
        }

        .help-content {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 135%; /* Position above the icon */
            left: 50%;
            margin-left: -100px; /* Center horizontally */
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: none;
            line-height: 1.4;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            pointer-events: none; /* Prevents flickering */
        }

        .help-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .help-tip:hover .help-content {
            visibility: visible;
            opacity: 1;
        }

        /* --- HEIGHT STANDARDIZATION --- */
        .form-control-styled {
            height: 64px; /* Standard Height */
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 0 15px;
            background: var(--foil-silver);
            border-radius: 4px;
            color: var(--text-dark);
            border: 1px solid #ccc;
            text-transform: uppercase;
            width: 100%;
            display: flex;
            align-items: center;
        }

        #currentDateDisplay {
            background: white;
            border: 2px solid #ccc;
            color: var(--text-dark); 
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        #currentDateDisplay:hover {
            background-color: var(--chili-dark);
            color: white;
            border-color: var(--chili-dark);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* File Input Area */
        .file-drop-area {
            height: 64px; /* Standard Height */
            box-sizing: border-box;
            position: relative;
            padding: 0 15px;
            border: 2px dashed #bbb;
            border-radius: 4px;
            transition: 0.2s;
            background: #fafafa;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .file-drop-area:hover {
            border-color: var(--chili-red);
            background: #fff5f5;
        }
        input[type="file"] {
            position: absolute;
            left: 0; top: 0; height: 100%; width: 100%;
            opacity: 0; cursor: pointer;
        }
        .file-msg { font-weight: 600; color: #666; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Shipment Chips --- */
        .shipment-options { 
            display: flex; 
            flex-wrap: nowrap; 
            gap: 10px; 
            width: 100%;
        }

        .shipment-chip {
            height: 64px;
            box-sizing: border-box;
            flex: 1; 
            min-width: 0; 
            padding: 0 5px;
            border: 2px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .shipment-chip:hover {
            border-color: var(--chili-dark);
        }

        .shipment-chip.active {
            background-color: var(--chili-dark);
            color: white;
            border-color: var(--chili-dark);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .shipment-chip .day-name { 
            display: block; 
            font-weight: 800; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            line-height: 1.2;
        }

        .shipment-chip .date-val { 
            font-size: 0.9rem; 
            font-weight: 500; 
            white-space: nowrap;
        }

        @media (max-width: 480px) {
            .shipment-chip .day-name { font-size: 0.7rem; }
            .shipment-chip .date-val { font-size: 0.8rem; }
            .shipment-options { gap: 5px; }
        }

        /* --- Buttons --- */
        .btn-primary {
            background-color: var(--chili-dark);
            color: white;
            border: none;
            padding: 16px 28px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            transition: background 0.2s, transform 0.1s;
        }

        .btn-primary:hover { background-color: #5c1d13; }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary {
            background-color: #999;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: background 0.2s;
        }
        .btn-secondary:hover { background-color: #777; }

        .btn-success {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: background 0.2s, transform 0.05s;
        }
        .btn-success:hover { background-color: #27632a; }

        /* Toast Notification */
        .toast {
            position: fixed;
            right: 24px;
            bottom: 24px;
            background: var(--success);
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(46,125,50,0.25);
            font-weight: 800;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            z-index: 3000;
            pointer-events: none;
        }
        .toast.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* --- Table --- */
        .table-responsive { overflow-x: auto; border: 1px solid #ccc; border-radius: 4px; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }

        th, td {
            text-align: left;
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #e0e0e0;
            font-weight: 800;
            color: var(--chili-dark);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tr.over-order { background-color: #fff0f0; }
        tr.over-order td { color: var(--danger); font-weight: 700; }

        /* Table Input Styling */
        .tbl-input {
            width: 80px; 
            padding: 5px; 
            border: 1px solid #ccc; 
            border-radius: 2px;
            font-weight: bold;
        }

        /* --- Settings Grid --- */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        /* --- Projections Grid --- */
        .projections-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* Force 7 equal columns */
            gap: 8px; /* Compact gap */
            background: #f8f8f8;
            padding: 15px 10px;
            border-radius: 4px;
            border: 1px solid #eee;
            overflow-x: visible; /* Remove scroll */
        }
        
        /* Mobile adjustment for grid */
        @media (max-width: 600px) {
            .projections-grid {
                /* On extremely small screens, this will squish, 
                   but user requested "condense to fit page" */
                gap: 4px;
                padding: 10px 5px;
            }
        }

        .projection-item {
            background: white;
            padding: 10px 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
            text-align: center;
            transition: box-shadow 0.2s;
            min-width: 0; /* Allows items to shrink below content size if needed */
        }

        .projection-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-color: #ccc;
        }

        .projection-label {
            display: block;
            font-weight: 800;
            color: var(--chili-dark);
            text-transform: uppercase;
            margin-bottom: 5px;
            font-size: 0.75rem; /* Smaller font for condensed view */
            line-height: 1.1;
        }

        .projection-input {
            width: 100%;
            padding: 6px 2px;
            font-size: 0.95rem;
            font-weight: 700;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            text-align: center;
        }

        .projection-input:focus {
            outline: none;
            border-color: var(--chili-red);
            box-shadow: 0 0 0 2px rgba(173, 46, 36, 0.1);
        }

        .setting-item {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .setting-header {
            font-weight: 800;
            color: var(--chili-dark);
            text-transform: uppercase;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        /* --- Input Wrapper (For Settings) --- */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .input-wrapper label { 
            font-size: 0.7rem; 
            color: #666; 
            text-transform: uppercase; 
            font-weight: 700; 
            display: block; 
            text-align: center;
            margin-bottom: 3px;
        }

        .input-wrapper input { 
            width: 100%; 
            padding: 5px 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            text-align: center;
            font-weight: 700;
            color: var(--text-dark);
            height: 34px; /* Fixed height for consistency */
            font-size: 1rem;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: var(--chili-red);
            box-shadow: 0 0 0 2px rgba(173, 46, 36, 0.1);
        }

        .action-bar { display: flex; justify-content: flex-end; margin-top: 20px; }

        #error-msg {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            border-left: 5px solid #c62828;
            display: none;
            font-weight: 600;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 4px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 2px solid var(--chili-dark);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .checkbox-wrapper {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            cursor: pointer;
        }
        .checkbox-wrapper label { cursor: pointer; text-transform: uppercase; font-size: 0.8rem; }

        /* --- Settings Sub-Navigation --- */
        .settings-subnav {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            overflow-x: auto; /* Allow scroll on small screens */
        }
        .subnav-btn {
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 700;
            color: #888;
            cursor: pointer;
            padding: 8px 15px;
            text-transform: uppercase;
            transition: all 0.2s;
            border-radius: 4px;
            white-space: nowrap;
        }
        .subnav-btn.active {
            background-color: var(--chili-dark);
            color: white;
        }
        .subnav-btn:hover:not(.active) {
            background-color: #eee;
            color: var(--chili-dark);
        }
        .settings-subcontent {
            display: none;
        }
        .settings-subcontent.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
    </style>
</head>
<body>

<!-- Navigation Bar -->
<div class="top-bar">
    <div class="app-title" onclick="switchSection('calculator')" title="Return to Home">Walk-In Verifier</div>
</div>

<!-- Warning Modal -->
<div id="warningModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Important Check</h3>
        <p>Ensure all shipments and the most recent inventory count were posted <strong>before</strong> uploading the inventory order CSV.</p>
        <div class="checkbox-wrapper">
            <input type="checkbox" id="dontShowAgain">
            <label for="dontShowAgain">Do not check again</label>
        </div>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeWarningModal()">Cancel</button>
            <button class="btn-primary" style="width: auto;" onclick="confirmVerification()">Proceed</button>
        </div>
    </div>
</div>

<!-- Apply 15k Usage Modal -->
<div id="apply15kModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Apply 15k Usage</h3>
        <p>This will overwrite <strong>Daily Usage</strong> for all items in the <strong>Item Limits</strong> section with the calculated 15k daily usage values.</p>
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeApply15kModal()">Cancel</button>
            <button class="btn-primary" style="width: auto;" onclick="confirmApply15k()">Continue</button>
        </div>
    </div>
</div>

<div class="container">

    <!-- CALCULATOR TAB -->
    <div id="calculator" class="tab-content active">
        <div class="card">
            <!-- Header with Cog -->
            <div class="section-header-wrapper">
                <h3>Inventory Calculator</h3>
                <button class="icon-btn" onclick="switchSection('settings')" title="Open Settings">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                </button>
            </div>

            <div class="control-panel">
                <!-- 1. CSV Upload -->
                <div class="panel-section">
                    <div class="panel-label">
                        1. Upload CSV
                        <!-- Base Code for Help Tooltip -->
                        <div class="help-tip">
                            <span class="help-icon">?</span>
                            <span class="help-content">Upload your order guide CSV.</span>
                        </div>
                    </div>
                    <div class="file-drop-area">
                        <span class="file-msg" id="fileNameDisplay">Select CSV File</span>
                        <input type="file" id="csvFile" accept=".csv" onchange="updateFileName(this)">
                    </div>
                </div>

                <!-- 2. Current Date (Locked) -->
                <div class="panel-section">
                    <div class="panel-label">2. Today's Date</div>
                        <div class="form-control-styled" id="currentDateDisplay" onclick="openDatePicker(event)" role="button" aria-label="Change current date">
                            <!-- JS will populate -->
                        </div>
                        <input type="date" id="currentDatePicker" style="display:none" onchange="handleDateChange(this)">
                </div>

                <!-- 3. Shipment Date (Chips) -->
                <div class="panel-section">
                    <div class="panel-label">3. Select Shipment Date</div>
                    <div class="shipment-options" id="shipmentContainer">
                        <!-- JS will populate chips -->
                    </div>
                    <input type="hidden" id="selectedShipmentDateValue">
                </div>
            </div>

            <button class="btn-primary" onclick="initiateVerification()">Verify Order</button>
            <div id="error-msg"></div>
        </div>

        <div class="card" id="resultsCard" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: nowrap; gap: 20px;">
                <h3 style="margin:0; white-space: nowrap;">Analysis Results</h3>
                <span id="summaryText" style="margin:0; font-size: 0.9rem; font-weight: 700; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
            </div>
            
            <div class="table-responsive">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>On Hand</th>
                            <th>In Transit</th>
                            <th>On Order</th>
                            <th>Est. Inventory</th>
                            <th>Variance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SETTINGS TAB -->
    <div id="settings" class="tab-content">
        <!-- Top Return Button -->
        <div style="margin-bottom: 15px;">
            <button class="btn-text-back" onclick="switchSection('calculator')">
                <svg viewBox="0 0 24 24">
                    <path d="M20,11H7.83l5.59-5.59L12,4l-8,8l8,8l1.41-1.41L7.83,13H20V11z"/>
                </svg>
                Return to Home
            </button>
        </div>

        <!-- Sub Navigation -->
        <div class="settings-subnav">
            <button id="btn-set-limits" class="subnav-btn active" onclick="switchSettingsTab('set-limits')">Item Limits</button>
            <button id="btn-set-usage" class="subnav-btn" onclick="switchSettingsTab('set-usage')">Usage Rates</button>
            <button id="btn-set-projections" class="subnav-btn" onclick="switchSettingsTab('set-projections')">Sales Projections</button>
        </div>

        <!-- ITEM LIMITS SUB-TAB -->
        <div id="set-limits" class="settings-subcontent active">
            <div class="card">
                <h3>Item Limits</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <p style="margin: 0; color: #555; font-size: 0.95rem;">
                        Adjust Max Inventory targets. Daily Usage is updated via the CSV calculator.
                    </p>
                </div>
                
                <div id="settingsList" class="settings-grid">
                    <!-- Javascript will populate this -->
                </div>
            </div>

            <!-- Action Bar (Moved specifically to Item Limits) -->
            <div class="card" style="border:none; box-shadow:none; background:transparent;">
                <div class="action-bar">
                    <button class="btn-success" style="width: auto;" onclick="saveSettings()">Save Configuration</button>
                    <button class="btn-primary" style="width: auto; background-color: #888; margin-left: 10px;" onclick="resetDefaults()">Reset Defaults</button>
                </div>
            </div>
        </div>

        <!-- USAGE RATES SUB-TAB -->
        <div id="set-usage" class="settings-subcontent">
            <div class="card">
                <h3>Usage Rates (Estimator)</h3>
                <p style="margin-bottom: 20px; color: #555; font-size: 0.95rem;">
                    Upload usage CSV to calculate rates, or manually adjust the Min/Max estimates below. 
                    <br><strong>Note:</strong> Editing Min/Max will reverse-calculate the Usage Rate.
                </p>
                
                <!-- CSV Upload for Rates -->
                <div class="control-panel" style="grid-template-columns: 1fr; margin-bottom: 20px;">
                     <div class="panel-section">
                        <div class="panel-label">
                            Update Rates via CSV
                            <div class="help-tip">
                                <span class="help-icon">?</span>
                                <span class="help-content">Upload the "Usage Report" CSV. The tool looks for Item Name in Column 3 and Usage/1000 in Column 6.</span>
                            </div>
                        </div>
                        <div class="file-drop-area">
                            <span class="file-msg" id="ratesFileName">Select Rates CSV</span>
                            <input type="file" id="ratesCsvFile" accept=".csv" onchange="processRatesCSV(this)">
                        </div>
                     </div>
                </div>
        
                <!-- Usage List -->
                <div class="table-responsive">
                    <table id="ratesTable">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Usage / $1k<br><small>(Read Only)</small></th>
                                <th>Min Usage (10k)<br><small>(Editable)</small></th>
                                <th>Max Usage (17k)<br><small>(Editable)</small></th>
                            </tr>
                        </thead>
                        <tbody id="ratesTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; text-align: right;">
                      <button class="btn-primary" style="width: auto; background-color: var(--chili-red);" onclick="applyUsageToSettings()">
                        Apply 15k Usage to Daily Limits
                      </button>
                </div>
            </div>
        </div>

        <!-- NEW: SALES PROJECTIONS SUB-TAB -->
        <div id="set-projections" class="settings-subcontent">
            <div class="card">
                <h3>Weekly Sales Projections</h3>
                <p style="margin-bottom: 20px; color: #555; font-size: 0.95rem;">
                    Enter your projected sales amount ($) for each day of the week starting from the most recent Sunday.
                </p>
                
                <div id="projectionsGrid" class="projections-grid">
                    <!-- Javascript will populate this -->
                </div>

                <div style="margin-top: 25px; text-align: right;">
                    <button class="btn-success" style="width: auto;" onclick="saveProjections()">
                        Save Projections
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Return Button -->
        <div class="bottom-return-container">
            <button class="btn-text-back" onclick="switchSection('calculator')">
                <svg viewBox="0 0 24 24">
                    <path d="M20,11H7.83l5.59-5.59L12,4l-8,8l8,8l1.41-1.41L7.83,13H20V11z"/>
                </svg>
                Return to Home
            </button>
        </div>
    </div>
</div>

<script>
    function switchSection(sectionId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- SETTINGS SUB-TAB LOGIC ---
    function switchSettingsTab(tabId) {
        // Remove active class from all content
        document.querySelectorAll('.settings-subcontent').forEach(el => el.classList.remove('active'));
        // Add active class to selected content
        document.getElementById(tabId).classList.add('active');
        
        // Update Buttons
        document.querySelectorAll('.subnav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('btn-' + tabId).classList.add('active');
    }

    // --- DEFAULT DATA ---
    const defaultMaxInventory = {
        "Limes, 40#": 2, "Lettuce": 9, "Cilantro": 16, "Chicken": 28, "Steak": 9,
        "Adobo Marinade 30 lb": 2, "Queso": 2, "Sofritas": 2, "Lemon/Lime Juice": 3, "Cheese": 6,
        "Corn w/ Poblano Mix": 12, "Bell Peppers": 10, "Tomato": 21, "Avocados": 27,
        "Burrito Size Tortilla 144 ct": 10, "Flour Tortilla": 2, "Taco Size Crispy Corn Tortilla PF, 240 ct": 2,
        "Black beans": 9, "Pinto beans": 9, "Sour Cream": 8, "Red Tomatillo Salsa 40 lb": 4,
        "Green Tomatillo Salsa, Finished, 40lbs": 6, "Clementine Oranges": 2, "Jalapeno Peppers, 10lb": 4
    };

    // Default Usage Rates (Per $1000 Sales)
    const defaultUsageRates = {
        "Adobo Marinade 30 lb": 0.0100,
        "Avocados": 0.5200,
        "Bell Peppers": 0.1824,
        "Black beans": 0.1765,
        "Burrito Size Tortilla 144 ct": 0.1765,
        "Cheese": 0.1294,
        "Chicken": 0.4441,
        "Cilantro": 0.3235,
        "Clementine Oranges": 0.0147,
        "Corn w/ Poblano Mix": 0.2600,
        "Flour Tortilla": 0.0300,
        "Green Tomatillo Salsa, Finished, 40lbs": 0.0882,
        "Jalapeno Peppers, 10lb": 0.1029,
        "Lemon/Lime Juice": 0.0735,
        "Lettuce": 0.2059,
        "Limes, 40#": 0.0250,
        "Pinto beans": 0.1500,
        "Queso": 0.0800,
        "Red Tomatillo Salsa 40 lb": 0.0941,
        "Sofritas": 0.0353,
        "Sour Cream": 0.1588,
        "Steak": 0.1471,
        "Taco Size Crispy Corn Tortilla PF, 240 ct": 0.0235,
        "Tomato": 0.3824
    };

    const defaultConsumption = {
        "Limes, 40#": .2, "Lettuce": 2.5, "Cilantro": 4, "Chicken": 6, "Steak": 2.5,
        "Adobo Marinade 30 lb": 0.33, "Queso": 1, "Sofritas": 0.5, "Lemon/Lime Juice": 0.5, "Cheese": 2,
        "Corn w/ Poblano Mix": 3.5, "Bell Peppers": 2.5, "Tomato": 5, "Avocados": 6,
        "Burrito Size Tortilla 144 ct": 2.5, "Flour Tortilla": 0.5, "Taco Size Crispy Corn Tortilla PF, 240 ct": .3,
        "Black beans": 1.5, "Pinto beans": 1, "Sour Cream": 2, "Red Tomatillo Salsa 40 lb": 1.5,
        "Green Tomatillo Salsa, Finished, 40lbs": 2, "Clementine Oranges": 0.3, "Jalapeno Peppers, 10lb": 1
    };

    const defaultSalesProjections = {
        "Monday": 10000,
        "Tuesday": 10000,
        "Wednesday": 10000,
        "Thursday": 12000,
        "Friday": 14000,
        "Saturday": 13000,
        "Sunday": 11000
    };

    // --- STATE MANAGEMENT ---
    let maxInventory = JSON.parse(localStorage.getItem('maxInventory')) || {...defaultMaxInventory};
    let consumptionDict = JSON.parse(localStorage.getItem('consumptionDict')) || {...defaultConsumption};
    let salesProjections = JSON.parse(localStorage.getItem('salesProjections')) || {...defaultSalesProjections};

    // Initialize with specific defaults if not present
    let usagePerThousand = JSON.parse(localStorage.getItem('usagePerThousand')) || {...defaultUsageRates};

    let globalCurrentDate = new Date();

    // Ensure usagePerThousand has keys for all items in defaultMaxInventory
    Object.keys(defaultMaxInventory).forEach(key => {
        if (usagePerThousand[key] === undefined) usagePerThousand[key] = 0;
    });

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        initDates();
        renderSettings();
        renderUsageSettings();
        renderProjections();
    });

    // --- DATE LOGIC ---
    function initDates(startDate = null) {
        // If a start date is provided, use it; otherwise use now
        const today = startDate ? new Date(startDate) : new Date();
        globalCurrentDate = today;
        
        const dateOptions = { weekday: 'long', month: 'short', day: 'numeric' };
        document.getElementById('currentDateDisplay').innerText = today.toLocaleDateString('en-US', dateOptions);

        const allowedDays = [1, 3, 5, 6]; // Mon, Wed, Fri, Sat
        const nextDates = [];
        let checkDate = new Date(today);
        
        // Find next 4 valid shipment dates
        for(let i = 0; i < 14; i++) {
            checkDate.setDate(checkDate.getDate() + 1);
            if (allowedDays.includes(checkDate.getDay())) {
                nextDates.push(new Date(checkDate));
            }
            if (nextDates.length >= 4) break; 
        }

        const container = document.getElementById('shipmentContainer');
        container.innerHTML = '';
        
        nextDates.forEach((date, index) => {
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' }); 
            const dateStr = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
            const fullValue = date.toISOString();

            const chip = document.createElement('div');
            chip.className = `shipment-chip ${index === 0 ? 'active' : ''}`;
            chip.onclick = () => selectShipmentDate(chip, fullValue);
            chip.innerHTML = `
                <span class="day-name">${dayName}</span>
                <span class="date-val">${dateStr}</span>
            `;
            container.appendChild(chip);

            if (index === 0) {
                document.getElementById('selectedShipmentDateValue').value = fullValue;
            }
        });
    }

    // Opens the hidden date picker
    function openDatePicker(e) {
        e.preventDefault();
        const picker = document.getElementById('currentDatePicker');
        
        // modern browser support
        if(picker.showPicker) {
            picker.showPicker();
        } else {
            picker.click();
        }
    }

    // Handles logic when date is changed via picker
    function handleDateChange(input) {
        // Create date from value string (YYYY-MM-DD) while avoiding timezone shifts
        const parts = input.value.split('-');
        if(parts.length === 3) {
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; // JS months are 0-11
            const day = parseInt(parts[2]);
            const newDate = new Date(year, month, day);
            
            initDates(newDate); // Re-init everything with new "today"
        }
    }

    function selectShipmentDate(element, value) {
        document.querySelectorAll('.shipment-chip').forEach(c => c.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('selectedShipmentDateValue').value = value;
    }

    function updateFileName(input) {
        const display = document.getElementById('fileNameDisplay');
        if (input.files && input.files.length > 0) {
            display.innerText = input.files[0].name;
            display.style.color = 'var(--chili-dark)';
            display.style.fontWeight = '700';
        } else {
            display.innerText = "Select CSV File";
            display.style.color = '#666';
        }
    }

    // --- MODAL LOGIC ---
    function initiateVerification() {
        const suppressed = localStorage.getItem('suppressInventoryWarning');
        if (suppressed === 'true') {
            processFile();
        } else {
            const modal = document.getElementById('warningModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    }

    function closeWarningModal() {
        const modal = document.getElementById('warningModal');
        modal.classList.remove('active');
        setTimeout(() => { modal.style.display = 'none'; }, 300);
    }

    function closeApply15kModal() {
        const modal = document.getElementById('apply15kModal');
        modal.classList.remove('active');
        setTimeout(() => { modal.style.display = 'none'; }, 300);
    }

    function openApply15kModal() {
        const modal = document.getElementById('apply15kModal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function confirmApply15k() {
        closeApply15kModal();
        proceedWithApplyUsage();
    }

    function confirmVerification() {
        const checkbox = document.getElementById('dontShowAgain');
        if (checkbox.checked) {
            localStorage.setItem('suppressInventoryWarning', 'true');
        }
        closeWarningModal();
        processFile();
    }

    // --- PROCESSING LOGIC ---
    function processFile() {
        const fileInput = document.getElementById('csvFile');
        const errorMsg = document.getElementById('error-msg');
        
        if (!fileInput.files.length) {
            errorMsg.innerText = "Please upload a CSV file first.";
            errorMsg.style.display = 'block';
            return;
        }

        errorMsg.style.display = 'none';
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function(e) {
            const text = e.target.result;
            try {
                const data = parseCSV(text);
                calculateAndRender(data);
            } catch (err) {
                errorMsg.innerText = "Error processing CSV: " + err.message;
                errorMsg.style.display = 'block';
            }
        };

        reader.readAsText(file);
    }

    function parseCSV(csvText) {
        const lines = csvText.split(/\r\n|\n/);
        const result = [];
        
        lines.forEach(line => {
            if (!line.trim()) return;
            
            const cols = [];
            let inQuote = false;
            let currentToken = '';
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuote = !inQuote;
                } else if (char === ',' && !inQuote) {
                    cols.push(currentToken);
                    currentToken = '';
                } else {
                    currentToken += char;
                }
            }
            cols.push(currentToken);

            const cleanCols = cols.map(c => c.trim().replace(/^"|"$/g, '').trim());
            
            if (cleanCols.length < 8) return; 
            if (isNaN(parseFloat(cleanCols[3])) && isNaN(parseFloat(cleanCols[7]))) return;

            result.push({
                name: cleanCols[2], 
                onHand: parseFloat(cleanCols[3]) || 0,
                inTransit: parseFloat(cleanCols[4]) || 0,
                amountToOrder: parseFloat(cleanCols[7]) || 0
            });
        });
        return result;
    }

    function calculateAndRender(data) {
        const current = new Date(globalCurrentDate);
        current.setHours(0,0,0,0);
        
        const shipmentVal = document.getElementById('selectedShipmentDateValue').value;
        const shipment = new Date(shipmentVal);
        shipment.setHours(0,0,0,0);

        const errorMsg = document.getElementById('error-msg');
        
        const diffTime = Math.abs(shipment - current);
        const daysUntilShipment = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        const tbody = document.querySelector('#resultsTable tbody');
        tbody.innerHTML = '';
        
        let overOrderCount = 0;

        const processedData = data.map(row => {
            // EXCLUSION: Skip the specific "20lb" double entry as requested
            if (row.name.includes("Corn w/ Poblano Mix, 20lb")) return null;

            const matchedKey = Object.keys(maxInventory).find(k => {
                const lowerKey = k.toLowerCase();
                const lowerName = row.name.toLowerCase();
                
                // Standard match (e.g., "Avocados" matches "Avocados 60ct")
                if (lowerName.includes(lowerKey)) return true;

                // Special handling for Beans labeled as "Beans, Black" or "Beans, Pinto"
                if (lowerKey === 'black beans' && lowerName.includes('black') && lowerName.includes('beans')) return true;
                if (lowerKey === 'pinto beans' && lowerName.includes('pinto') && lowerName.includes('beans')) return true;
                
                return false;
            });

            if (!matchedKey) return null; 

            const maxInv = maxInventory[matchedKey];
            const consumption = consumptionDict[matchedKey] || 1;
            
            // New Logic for Estimated Inventory
            const usageUntilShipment = consumption * daysUntilShipment;
            const totalAfterOrder = row.onHand + row.inTransit + row.amountToOrder;
            const estimatedInventory = totalAfterOrder - usageUntilShipment;
            
            // Variance logic: Target Max (maxInv) - Estimated Inventory
            // If positive, we have room under the cap. If negative, we are over the cap.
            let diff = maxInv - estimatedInventory;

            if (row.amountToOrder === 0 && diff < 0) {
                diff = 0;
            }

            const isOver = diff < 0;
            
            return {
                ...row,
                matchedKey,
                estimatedInventory,
                diff,
                isOver
            };
        }).filter(item => item !== null);

        if (processedData.length === 0) {
            errorMsg.innerText = "No matching items found. Please check item names in Settings.";
            errorMsg.style.display = 'block';
            document.getElementById('resultsCard').style.display = 'none';
            return;
        }

        processedData.sort((a, b) => {
            if (a.isOver === b.isOver) return a.name.localeCompare(b.name);
            return a.isOver ? -1 : 1;
        });

        processedData.forEach(item => {
            const tr = document.createElement('tr');
            if (item.isOver) {
                tr.classList.add('over-order');
                overOrderCount++;
            }

            tr.innerHTML = `
                <td><strong>${item.name}</strong></td>
                <td>${item.onHand.toFixed(2)}</td>
                <td>${item.inTransit.toFixed(2)}</td>
                <td>${item.amountToOrder.toFixed(2)}</td>
                <td>${item.estimatedInventory.toFixed(2)}</td>
                <td>${item.diff.toFixed(2)}</td>
                <td><span style="font-weight:800; color:${item.isOver ? '#d32f2f' : '#2e7d32'}">
                    ${item.isOver ? 'OVER ORDER' : 'OK'}
                </span></td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('resultsCard').style.display = 'block';
        
        const dayName = shipment.toLocaleDateString('en-US', { weekday: 'long' });
        document.getElementById('summaryText').innerText = 
            `${dayName} Shipment â€¢ ${overOrderCount} Issues Found`;
        
        document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
    }

    // --- SETTINGS LOGIC ---
    function renderSettings() {
        const container = document.getElementById('settingsList');
        container.innerHTML = '';
        const allKeys = new Set([...Object.keys(maxInventory), ...Object.keys(consumptionDict)]);
        const sortedKeys = Array.from(allKeys).sort();

        sortedKeys.forEach(key => {
            const div = document.createElement('div');
            div.className = 'setting-item';
            // Compact styling inline for simplicity
            div.style.padding = '12px 15px';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'space-between';
            
            div.innerHTML = `
                <div style="font-weight: 800; color: var(--chili-dark); font-size: 0.85rem; line-height:1.2; padding-right:10px;">${key}</div>
                <div style="display: flex; align-items: center; gap: 15px; flex-shrink: 0;">
                    <div style="text-align: right;">
                        <div style="font-size: 0.65rem; font-weight: 700; color: #888; text-transform: uppercase;">Usage</div>
                        <div style="font-weight: 700; font-size: 0.9rem; color: #333;">${(consumptionDict[key] || 0).toFixed(2)}</div>
                    </div>
                    <div class="input-wrapper" style="width: 70px;">
                        <label>Max</label>
                        <input type="number" step="0.1" id="max_${key}" value="${maxInventory[key] || 0}">
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // --- NEW USAGE SETTINGS LOGIC ---
    function renderUsageSettings() {
        const tbody = document.getElementById('ratesTableBody');
        tbody.innerHTML = '';
        
        const allKeys = Object.keys(usagePerThousand).sort();

        allKeys.forEach(key => {
            const upt = usagePerThousand[key] || 0;
            const minUsage = (upt * 10).toFixed(2); // 10k Sales
            const maxUsage = (upt * 17).toFixed(2); // 17k Sales

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${key}</td>
                <td style="font-weight:bold; color:#666;" id="rate_${key}">${upt.toFixed(4)}</td>
                <td>
                    <input type="number" step="0.1" class="tbl-input" value="${minUsage}"
                        onchange="updateFromMin('${key}', this.value)">
                </td>
                <td>
                    <input type="number" step="0.1" class="tbl-input" value="${maxUsage}"
                        onchange="updateFromMax('${key}', this.value)">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Manual Updates to Min/Max should reverse-calculate the Rate
    function updateFromMin(key, value) {
        let val = parseFloat(value) || 0;
        // Min is based on 10k sales. Rate = Min / 10.
        let newRate = val / 10;
        usagePerThousand[key] = newRate;
        renderUsageSettings(); // Re-render to update Rate and Max column
    }

    function updateFromMax(key, value) {
        let val = parseFloat(value) || 0;
        // Max is based on 17k sales. Rate = Max / 17.
        let newRate = val / 17;
        usagePerThousand[key] = newRate;
        renderUsageSettings(); // Re-render to update Rate and Min column
    }

    // The user wants to use the adjusted numbers to update the "Item Limit Daily Usage"
    function applyUsageToSettings() {
        openApply15kModal();
    }

    function proceedWithApplyUsage() {
        const allKeys = Object.keys(usagePerThousand);
        let count = 0;
        
        allKeys.forEach(key => {
            const upt = usagePerThousand[key] || 0;
            const avgUsage = parseFloat((upt * 15).toFixed(2)); // Calculate Avg (15k)
            
            // Update the consumption dictionary (which feeds the Daily Usage inputs)
            consumptionDict[key] = avgUsage;
            count++;
        });

        // Trigger full save of all configurations (including usagePerThousand and consumptionDict)
        saveSettings();
        
        // Re-render the top settings list to show new values
        renderSettings();
        
        // SWITCH to Settings section and Item Limits tab to show the user the updates
        switchSection('settings');
        switchSettingsTab('set-limits');
        
        showToast(`Updated and saved Daily Usage for ${count} items based on 15k sales.`);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function processRatesCSV(input) {
        const file = input.files[0];
        if(!file) return;

        // Visual update
        const display = document.getElementById('ratesFileName');
        display.innerText = file.name;
        display.style.color = 'var(--chili-dark)';
        display.style.fontWeight = '700';

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split(/\r\n|\n/);
            let updatedCount = 0;

            // Helper to parse CSV line correctly handling quotes
            const parseLine = (line) => {
                const result = [];
                let start = 0;
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    if (line[i] === '"') {
                        inQuotes = !inQuotes;
                    } else if (line[i] === ',' && !inQuotes) {
                        result.push(line.substring(start, i).trim().replace(/^"|"$/g, ''));
                        start = i + 1;
                    }
                }
                result.push(line.substring(start).trim().replace(/^"|"$/g, ''));
                return result;
            };

            lines.forEach((line, index) => {
                if(!line.trim()) return;
                
                // Parse the line
                const cols = parseLine(line);

                // Check if we have enough columns (Need index 2 and 5)
                // Item Name is Column 3 (Index 2)
                // Usage Per 1000 is Column 6 (Index 5)
                if(cols.length >= 6) {
                    const name = cols[2]; // Column 3
                    
                    // Explicitly exclude the "20lb" variant
                    if (name.includes("Corn w/ Poblano Mix, 20lb")) return;
                    
                    // Handle accounting format (0.03) -> -0.03 if necessary, though usually positive
                    let valStr = cols[5]; // Column 6
                    if(valStr.includes('(')) {
                        valStr = '-' + valStr.replace(/[()]/g, '');
                    }
                    let val = parseFloat(valStr);

                    // Skip header row if it contains "Ing. Desc."
                    if (name.includes("Ing. Desc.")) return;

                    // --- UNIT CONVERSION LOGIC ---
                    // Convert Pounds to Cases for specific items as requested and float to 2 decimals
                    const lowerName = name.toLowerCase();
                    if (lowerName.includes("cheese")) {
                        val = val / 42; // 42 lb cases
                        val = parseFloat(val.toFixed(4)); // Keep precision for rate
                    } else if (lowerName.includes("chicken")) {
                        val = val / 44; // 44 lb cases
                        val = parseFloat(val.toFixed(4));
                    } else if (lowerName.includes("limes")) {
                        val = val / 40; // 40 lb cases
                        val = parseFloat(val.toFixed(4));
                    } else if (lowerName.includes("steak")) {
                        val = val / 40; // 40 lb cases
                        val = parseFloat(val.toFixed(4));
                    }

                    // Fix for Naming conventions (CSV vs App)
                    let searchName = name;
                    
                    // Beans
                    if (lowerName.includes("beans") && lowerName.includes("black")) searchName = "Black beans";
                    if (lowerName.includes("beans") && lowerName.includes("pinto")) searchName = "Pinto beans";

                    // Produce & Salsas
                    if (lowerName.includes("jalapeno")) searchName = "Jalapeno Peppers, 10lb";
                    if (lowerName.includes("corn") && lowerName.includes("poblano")) searchName = "Corn w/ Poblano Mix";
                    if (lowerName.includes("green") && lowerName.includes("tomatillo")) searchName = "Green Tomatillo Salsa, Finished, 40lbs";
                    if (lowerName.includes("red") && lowerName.includes("tomatillo")) searchName = "Red Tomatillo Salsa 40 lb";

                    // Tortillas
                    if (lowerName.includes("taco") && lowerName.includes("corn")) searchName = "Taco Size Crispy Corn Tortilla PF, 240 ct";
                    if (lowerName.includes("burrito") && lowerName.includes("tortilla")) searchName = "Burrito Size Tortilla 144 ct";

                    // Try to match existing keys mostly
                    const matchedKey = Object.keys(usagePerThousand).find(k => 
                        searchName.toLowerCase().includes(k.toLowerCase()) || k.toLowerCase().includes(searchName.toLowerCase())
                    );

                    if(matchedKey && !isNaN(val)) {
                        usagePerThousand[matchedKey] = val;
                        updatedCount++;
                    }
                }
            });
            
            renderUsageSettings();
            showToast(`Updated ${updatedCount} usage rates from CSV.`);
        };
        reader.readAsText(file);
    }

    // --- SALES PROJECTIONS LOGIC ---
    function renderProjections() {
        const container = document.getElementById('projectionsGrid');
        container.innerHTML = '';
        
        // Logic for "Most Recent Sunday"
        // If today is Sunday, we start today. 
        // If today is Mon-Sat, we go back to last Sunday.
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0 is Sunday
        const diff = today.getDate() - dayOfWeek; 
        const sunday = new Date(today.setDate(diff));

        // Create array of 7 days starting from that Sunday
        const weekDates = [];
        for(let i=0; i<7; i++) {
            const d = new Date(sunday);
            d.setDate(sunday.getDate() + i);
            weekDates.push(d);
        }

        weekDates.forEach(dateObj => {
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            const dateStr = dateObj.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
            
            const div = document.createElement('div');
            div.className = 'projection-item';
            
            const rawVal = salesProjections[dayName] || 0;
            // Format existing value with commas for display
            const formattedVal = rawVal.toLocaleString('en-US'); 
            
            div.innerHTML = `
                <span class="projection-label">
                    ${dayName}
                    <div style="font-weight:400; color:#666; font-size:0.8em; margin-top:2px;">${dateStr}</div>
                </span>
                <input type="text" 
                       id="proj_${dayName}" 
                       class="projection-input" 
                       value="${formattedVal}" 
                       placeholder="0"
                       onkeyup="formatCurrency(this)"
                       onblur="formatCurrency(this)">
            `;
            container.appendChild(div);
        });
    }

    // New helper to format input with commas
    function formatCurrency(input) {
        // Remove non-digit chars
        let val = input.value.replace(/[^0-9]/g, '');
        if(!val) {
             input.value = '';
             return;
        }
        // Format with commas
        input.value = parseInt(val).toLocaleString('en-US');
    }

    function saveProjections() {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        
        days.forEach(day => {
            const input = document.getElementById(`proj_${day}`);
            if(input) {
                // Strip commas before saving as number
                const rawVal = input.value.replace(/,/g, '');
                salesProjections[day] = parseFloat(rawVal) || 0;
            }
        });
        
        localStorage.setItem('salesProjections', JSON.stringify(salesProjections));
        showToast('Sales projections saved successfully!');
    }

    function saveSettings() {
        const allKeys = new Set([...Object.keys(maxInventory), ...Object.keys(consumptionDict)]);
        
        allKeys.forEach(key => {
            const maxEl = document.getElementById(`max_${key}`);
            // Daily Usage is now managed via CSV, so we don't save from this view anymore
            
            if (maxEl) maxInventory[key] = parseFloat(maxEl.value);
        });

        localStorage.setItem('maxInventory', JSON.stringify(maxInventory));
        localStorage.setItem('consumptionDict', JSON.stringify(consumptionDict));
        localStorage.setItem('usagePerThousand', JSON.stringify(usagePerThousand));
        
        showToast('Configuration saved successfully!');
    }

    function showToast(message) {
        let toast = document.getElementById('saveToast');
        if (!toast) return;
        toast.innerText = message;
        toast.classList.add('active');
        clearTimeout(toast._timeout);
        toast._timeout = setTimeout(() => {
            toast.classList.remove('active');
        }, 3000);
    }

    function resetDefaults() {
        if(confirm("Reset all settings to defaults?")) {
            maxInventory = {...defaultMaxInventory};
            consumptionDict = {...defaultConsumption};
            
            // Reset usage to NEW DEFAULT UPT (not 0)
            usagePerThousand = {...defaultUsageRates};
            salesProjections = {...defaultSalesProjections};
            
            Object.keys(defaultMaxInventory).forEach(key => {
                 if (usagePerThousand[key] === undefined) usagePerThousand[key] = 0;
            });

            localStorage.setItem('maxInventory', JSON.stringify(maxInventory));
            localStorage.setItem('consumptionDict', JSON.stringify(consumptionDict));
            localStorage.setItem('usagePerThousand', JSON.stringify(usagePerThousand));
            localStorage.setItem('salesProjections', JSON.stringify(salesProjections));
            
            renderSettings();
            renderUsageSettings();
            renderProjections();
        }
    }
</script>

<!-- Toast notification element -->
<div id="saveToast" class="toast" role="status" aria-live="polite" style="display:block;">&nbsp;</div>

</body>
</html>